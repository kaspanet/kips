```
KIP: 15
Layer: Consensus (hard fork)
Title: Canonical Transaction Ordering and Selected Parent Commitment in AcceptedIDMerkleRoot
Type: Consensus change (block format)
Author: Mike Zak <feanorr@gmail.com>
Comments-URI: # TODO https://research.kas.pa/t/crescendo-hardfork-discussion-thread/279
created: 2025-02-01
updated: 2025-02-01
Status: Draft
```

# Motivation
L2 networks on top of Kaspa rely on Kaspa for consensus. In other words, the Kaspa L1 provides the transaction order, while L2 interprets the transaction payloads and executes corresponding logic.

In such cases the ordering of transaction acceptance in L1 has to be the ordering of transaction execution on L2.  As such, the acceptance and ordering of transactions on L1 is of utmost importance to L2 applications. 

Due to the nature of some L2 applications, the aforementioned ordering should be provable even after the relevant part of the BlockDAG has been pruned, trusting only the data available to any Kaspa node post-pruning.

TODO: Add motivation for adding SuperAcceptedIDMerkleRoot

# Current situation
Currently the block headers in Kaspa contain a field named AcceptedIDMerkleRoot, which contains a commitment to all transactions accepted by this block.  
For the interests of a future optimization (TODO: provide explanation of such optimization), the transactions are sorted lexicographically before calculating the MerkleTree, and as such, their order of acceptance is not part of the commitment.

To prove the acceptance of a transaction one should provide an inclusion proof of the transaction's ID inside the corresponding AcceptedIDMerkleTree of a SelectedParentChain block.
In addition, to prove that a pruned transaction *tx* is indeed accepted by pruned SelectedParentChain block *acceptingBlock*, one should provide a Proof of Chain Memebers as defined in [KIP-0006](kip-0006.md).

The above solution provides a framework to prove a partial ordering of the transactions:
If `tx1.AcceptingBlock.BlueScore < tx2.AcceptingBlock.BlueScore` then *tx1* was accepted (and thus - should be executed on L2) before *tx2*.
However, if *tx1* and *tx2* were accepted by the same block - there is no commitment to their ordering.

In other words, the only way to prove the ordering between *tx1* and *tx2* that were both accepted by the same *acceptingBlock* is only through accessing the original (now pruned) block data and running Phantom and the rest of the acceptance algorithm to verify which transaction was accepted first.

# Proposal
We a new block-header field named **AcceptanceCommitment** to replace **AcceptedIDMerkleRoot**.

**AcceptanceCommitment** will be calculated as following:
1. **AcceptedIDMerkleRoot** = the root of a tree constructed from the block's AcceptanceData keeping canonical ordering 
(in other words - the same way AcceptedIDMerkleRoot was calculated up until now, but skipping the lexicographical ordering)
2. **AcceptanceCommitment** = hash(*SelectedParent.AcceptanceCommitment*, *AcceptedIDMerkleRoot*)  (TODO: Define which hash to use).


# Backwards compatibility
Breaks consensus rules, requires hardfork.