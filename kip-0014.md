```
title: KIP-14: Crescendo Hardfork
status: Draft
type: Consensus Change
author: [Your Name] <your-email@example.com>
created: YYYY-MM-DD
updated: YYYY-MM-DD
```

# KIP-14: Crescendo Hardfork

## Abstract
This KIP proposes the implementation of the Crescendo Hardfork for the Kaspa network. It outlines the consensus changes to be introduced and details the strategy for transitioning to the new fork.

## Motivation
Provide a concise explanation of the need for the Crescendo Hardfork, addressing any network limitations, issues, or improvements it seeks to resolve.

## Specification
### Consensus Changes
1. **Increasing Blocks Per Second (bps) from 1 to 10**:
   - This change is governed by a consensus parameter named `target_time_per_block` (milliseconds), which controls the average time between blocks. To increase bps from 1 to 10, the `target_time_per_block` must be reduced from 1000 ms to 100 ms.
   - This adjustment will immediately cause the difficulty adjustment algorithm to reduce the difficulty by a factor of 10.

2. **Re-adjusting the Ghostdag K Parameter**:
   - Reducing block time leads to a higher rate of parallel blocks. Consequently, the Ghostdag K parameter, which is a function of $2 \lambda D$ (where $\lambda$ is the block rate and $D$ is the a priori delay bound), must be recalibrated to maintain network stability and performance.
   - The new Ghostdag K is recalculated to be 124 based on the Poisson tail analysis.

3. **Scaling Time-Duration-Based Consensus Parameters**:
   - Several parameters defined by time duration but applied via block count must be scaled with the new bps:
     - **Finality Depth ($\phi$)**: Previously defined for a 24-hour duration at 1 bps (86,400 blocks), it will now correspond to a 12-hour duration at 10 bps (432,000 blocks).
     - **Merge Depth Bound ($M$)**: Defined for a 1-hour duration, it will now increase from 3600 blocks at 1 bps to 36,000 blocks at 10 bps.
     - **Pruning Depth**: Calculated as $\phi + 2M + 4KL + 2K + 2$, where:
       - $\phi$: Finality Depth
       - $M$: Merge Depth Bound
       - $L$: Mergeset Size Limit
       - $K$: Ghostdag K
     - **Coinbase Maturity**: Originally defined as 100 seconds or ~100 blocks at 1 bps, this will now correspond to 1000 blocks at 10 bps.

4. **Conservative Scaling of Performance-Impacting Parameters**:
   - **Max Block Parents**: Increased from 10 to 16. Based on TN11, 16 remains above the average DAG width, ensuring stability while improving performance.
   - **Mergeset Size Limit ($L$)**: Increased from 180 to 248 (2K), to accommodate the higher bps while maintaining storage efficiency.

5. **Activation of KIP-4: Sparse DAA and Median Time Windows**:
   - Transitioning to a sparse Difficulty Adjustment Algorithm (DAA) and sparse Median Time window while maintaining the duration of previous windows.
   - Defined by sampling time intervals (in seconds) and scaled by BPS to achieve sampling block intervals:
     - **PAST_MEDIAN_TIME_SAMPLE_INTERVAL**: Set to 10 seconds.
     - **DIFFICULTY_WINDOW_SAMPLE_INTERVAL**: Set to 4 seconds.

6. **First Direct Block Parent as Ghostdag Selected Parent**:
   - A new consensus rule is introduced where the first direct block parent must be the Ghostdag selected parent. This simplifies bringing a witness of the selected chain, particularly for scenarios pre-KIP-6 (which is unplanned for this hardfork).

7. **Adjustments to the Coinbase Reward Table**:
   - The reward table will continue to map from months to rewards, but the reward is now considered a per-second reward. To calculate the per-block reward, the per-second reward is divided by the blocks per second (BPS).
   - Special care must be taken to correctly calculate the current emission month. Previously, the DAA score (essentially a block count) mapped directly to seconds since blocks were produced at a rate of 1 block per second. Post-hardfork, with 10 BPS, the DAA score at activation must be used to maintain accurate second counting.
     - If `activation_daa_score` is the DAA score at the time of 10 BPS activation and `current_daa_score` > `activation_daa_score`, then:
       $$\text{seconds since deflationary} = \text{activation daa score} + \frac{\text{current daa score} - \text{activation daa score}}{\text{new bps}}$$
   - The `seconds_since_deflationary` value can then be used as before to determine the current emission month.

8. **Activation of Additional KIPs**:
   - **KIP-9 (Storage Mass)**: Introduces storage mass calculation for enhanced scalability and performance metrics.
   - **KIP-13 (Transient Storage Mass)**: Implements transient storage mass to optimize short-term storage operations.
   - **KIP-10 (Script Engine Enhancements)**: Activates covenants via direct introspection within the script engine, enabling advanced transaction scripting.

### Transitioning Strategy
- **Handling Difficulty Adjustment During Transition**:
   - A general challenge arises when switching BPS, where the DAA window post-activation spans both the 1 BPS era and the 10 BPS era. Care must be taken to avoid overly decreasing difficulty due to the slower rate at the prefix of the window.
   - Additionally, with the switch to KIP-4, the strategy changes from a full DAA window to a sparse one.
   - **Proposed Solution**:
     - Reset the DAA window and start it anew at the activation point. For example, one second after activation, the window will include only the first activated header.
     - To mitigate potential difficulty volatility in the first few seconds, fix the difficulty constant (equal to the activation point difficulty) until the new window accumulates sufficient size.

- **Pruning Point Adjustment**:
   - Upon activation, the pruning depth increases to accommodate the higher BPS. However, this does not imply that the pruning point itself should regress to achieve the new depth immediately.
   - The pruning point will remain fixed at its current location until a point above it accumulates sufficient depth under the new parameters. This ensures a smooth transition and avoids unnecessary pruning point instability.

- **Fork Activation Mechanism**: Specify block height or timestamp for activation.
- **Upgrade Timeline**: Define stages for node updates and any compatibility windows.
- **Handling Edge Cases**: Outline how the network will address potential edge cases during the transition.

## Rationale
Explain the reasoning behind each proposed consensus change and the overall transition strategy, highlighting why these decisions are optimal for the network.

## Backward Compatibility
Discuss the impact on previous versions of the protocol and how backward compatibility will be maintained or deprecated features will be handled.

## Test Plan
Detail the testing methodology for ensuring the robustness of the changes, including testnet simulations, community testing, and potential bug bounty programs.

## Security Considerations
Analyze potential security risks introduced by the Crescendo Hardfork and describe mitigations to address them.

## Implementation
Provide links to relevant code repositories, development branches, or prototypes related to the Crescendo Hardfork implementation.

## References
- [Prunality Analysis](https://github.com/kaspanet/docs/blob/main/Reference/prunality/Prunality.pdf)
Include any references, links, or related KIPs relevant to the Crescendo Hardfork.
